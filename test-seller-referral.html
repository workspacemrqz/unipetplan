<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teste de Referência de Vendedor</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .test-section {
      background: #f5f5f5;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    .success {
      color: green;
      font-weight: bold;
    }
    .error {
      color: red;
      font-weight: bold;
    }
    .info {
      background: #e7f3ff;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    #result {
      margin-top: 20px;
      padding: 20px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 100px;
    }
  </style>
</head>
<body>
  <h1>Teste de Referência de Vendedor - UNIPET PLAN</h1>
  
  <div class="test-section">
    <h2>1. Simular acesso via link de referência</h2>
    <p>Vendedor: Gabriel (ID: 64028254-e67e-40f3-9430-ddeea661bf03)</p>
    <p>URL: /vendedor/gabreil-mgldr4zm</p>
    <button onclick="simulateReferralCapture()">Capturar Referência</button>
  </div>

  <div class="test-section">
    <h2>2. Verificar dados salvos no localStorage</h2>
    <button onclick="checkLocalStorage()">Verificar localStorage</button>
  </div>

  <div class="test-section">
    <h2>3. Simular checkout com referência</h2>
    <button onclick="simulateCheckout()">Simular Checkout</button>
  </div>

  <div class="test-section">
    <h2>4. Verificar comissões do vendedor</h2>
    <button onclick="checkCommissions()">Verificar Comissões</button>
  </div>

  <div class="test-section">
    <h2>5. Limpar referência</h2>
    <button onclick="clearReferral()">Limpar localStorage</button>
  </div>

  <div id="result">
    <h3>Resultados:</h3>
    <div id="output"></div>
  </div>

  <script>
    const SELLER_ID = '64028254-e67e-40f3-9430-ddeea661bf03';
    const SELLER_SLUG = 'gabreil-mgldr4zm';
    const REFERRAL_KEY = 'unipet_seller_referral';

    function log(message, type = 'info') {
      const output = document.getElementById('output');
      const time = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
      output.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
    }

    async function simulateReferralCapture() {
      log('Simulando captura de referência...');
      
      // Simular o que o componente SellerReferral faz
      const referral = {
        sellerId: SELLER_ID,
        sellerSlug: SELLER_SLUG,
        timestamp: Date.now(),
        expiresAt: Date.now() + (7 * 24 * 60 * 60 * 1000) // 7 dias
      };
      
      try {
        localStorage.setItem(REFERRAL_KEY, JSON.stringify(referral));
        log('✅ Referência salva no localStorage', 'success');
        
        // Rastrear o clique
        const response = await fetch('/api/seller/track-click', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ sellerId: SELLER_ID }),
        });
        
        if (response.ok) {
          log('✅ Clique rastreado com sucesso', 'success');
        } else {
          log('❌ Erro ao rastrear clique: ' + response.status, 'error');
        }
      } catch (error) {
        log('❌ Erro: ' + error.message, 'error');
      }
    }

    function checkLocalStorage() {
      log('Verificando localStorage...');
      const stored = localStorage.getItem(REFERRAL_KEY);
      
      if (stored) {
        const referral = JSON.parse(stored);
        const now = Date.now();
        const expiresIn = Math.floor((referral.expiresAt - now) / (1000 * 60 * 60 * 24));
        
        log('✅ Referência encontrada:', 'success');
        log(`  - Seller ID: ${referral.sellerId}`);
        log(`  - Seller Slug: ${referral.sellerSlug}`);
        log(`  - Expira em: ${expiresIn} dias`);
      } else {
        log('⚠️ Nenhuma referência encontrada no localStorage', 'error');
      }
    }

    async function simulateCheckout() {
      log('Simulando checkout com referência...');
      
      const stored = localStorage.getItem(REFERRAL_KEY);
      if (!stored) {
        log('❌ Nenhuma referência no localStorage. Execute "Capturar Referência" primeiro.', 'error');
        return;
      }
      
      const referral = JSON.parse(stored);
      log(`✅ Usando referência do vendedor: ${referral.sellerId}`, 'success');
      
      // Dados de teste para checkout
      const checkoutData = {
        sellerId: referral.sellerId, // Este é o campo importante!
        paymentData: {
          customer: {
            name: 'Teste Referência',
            email: 'teste@example.com',
            cpf: '000.000.000-00'
          },
          payment: {
            cardNumber: '4111111111111111',
            holder: 'TESTE REFERENCIA',
            expirationDate: '12/2025',
            securityCode: '123',
            installments: 1
          },
          pets: [{
            name: 'Pet Teste',
            species: 'dog',
            breed: 'SRD',
            age: 2,
            weight: 10,
            sex: 'M',
            castrated: false
          }]
        },
        planData: {
          planId: 'plan-test',
          billingPeriod: 'monthly',
          amount: 150.00
        },
        paymentMethod: 'credit_card',
        addressData: {
          phone: '(11) 99999-9999',
          address: 'Rua Teste',
          number: '123',
          complement: '',
          district: 'Centro',
          city: 'São Paulo',
          state: 'SP',
          cep: '01000-000'
        }
      };
      
      log('Dados do checkout preparados com sellerId: ' + checkoutData.sellerId);
      log('✅ Em um checkout real, este sellerId seria enviado para /api/checkout/simple-process', 'success');
      log('✅ O backend então criaria o contrato com o sellerId associado', 'success');
    }

    async function checkCommissions() {
      log('Verificando comissões do vendedor...');
      
      try {
        // Verificar comissões
        const commissionsResponse = await fetch(`/api/seller/commissions/${SELLER_ID}`);
        if (commissionsResponse.ok) {
          const commissions = await commissionsResponse.json();
          log('✅ Comissões:', 'success');
          log(`  - Total a receber: R$ ${commissions.totalToReceive}`);
          log(`  - CPA: R$ ${commissions.totalCPA} (${commissions.cpaPercentage}%)`);
          log(`  - Recorrente: R$ ${commissions.totalRecurring} (${commissions.recurringPercentage}%)`);
          log(`  - Contratos: ${commissions.contractsCount}`);
        } else {
          log('❌ Erro ao buscar comissões: ' + commissionsResponse.status, 'error');
        }
        
        // Verificar analytics
        const analyticsResponse = await fetch(`/api/seller/analytics/${SELLER_ID}`);
        if (analyticsResponse.ok) {
          const analytics = await analyticsResponse.json();
          log('✅ Analytics:', 'success');
          log(`  - Cliques: ${analytics.clicks}`);
          log(`  - Conversões: ${analytics.conversions}`);
          log(`  - Taxa de conversão: ${analytics.conversionRate}%`);
        } else {
          log('❌ Erro ao buscar analytics: ' + analyticsResponse.status, 'error');
        }
      } catch (error) {
        log('❌ Erro: ' + error.message, 'error');
      }
    }

    function clearReferral() {
      localStorage.removeItem(REFERRAL_KEY);
      log('✅ Referência removida do localStorage', 'success');
    }
  </script>
</body>
</html>